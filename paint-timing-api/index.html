<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta http-equiv=Accept-CH content="DPR, Viewport-Width, Width"><title>PerformanceObserver and Paint Timing API - José M. Pérez</title><meta name=description content="A quick look at the Paint Timing API to get metrics about render events on our pages."><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"><link rel=author href="https://plus.google.com/107456024651797783420"/><link rel=alternate type=application/rss+xml title="Jose M. Perez" href=https://jmperezperez.com/feed.xml><meta name=twitter:card content=summary_large_image><meta name=twitter:url content="https://jmperezperez.com/paint-timing-api/" property=og:url><meta name=twitter:title content="PerformanceObserver and Paint Timing API - José M. Pérez" property=og:title><meta name=twitter:description content="A quick look at the Paint Timing API to get metrics about render events on our pages." property=og:description><meta name=twitter:site content=@jmperezperez><meta property=og:image content=https://jmperezperez.com/assets/images/posts/paint-timing-filmstrip.png><meta name=twitter:image content=https://jmperezperez.com/assets/images/posts/paint-timing-filmstrip.png><meta property=fb:app_id content=1702266270006013><meta property=fb:pages content="1639848659664211"/><link rel=canonical href="https://jmperezperez.com/paint-timing-api/"/><style>*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;border:none;font:inherit;margin:0;padding:0;vertical-align:baseline}button,input{background:0 0}body{background:#fff;color:#555;font-family:Georgia,Times;font-weight:300;font-style:normal;font-size:19px;line-height:1.725;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-text-size-adjust:100%}@media(max-width:800px){body{font-size:17px}}@media(max-width:600px){body{font-size:15px}}h1,h2,h3,h4,h5{color:#212121;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-weight:600;font-size:1em;line-height:1.3;margin-bottom:1em}h2,h3,h4,h5{margin-top:2em}#menu a,.button{font-size:1em;font-weight:400}.post ol,.post ul,amp-video,amp-vimeo,amp-youtube,iframe,p,video{margin:0;margin-bottom:1em}twitterwidget{margin-bottom:1em!important}a{color:#2a7cb2;font-weight:inherit;text-decoration:none;transition:color .15s ease-out,border-bottom-color .15s ease-out}a:hover{color:#2a7cb2}p a{border-bottom:1px solid #eee}p a:hover{border-bottom-color:#212121}strong{font-weight:700}em{font-style:italic}h1{font-size:1.7em}h2{color:#444;font-size:1.6em;font-weight:400}h3{color:#666;font-size:1.4em;font-weight:400}h4{font-size:1.18em}h5{font-size:1em}a h1,a h2,a h3,a h4,a h5{transition:color .15s ease-out}a:hover h1,a:hover h2,a:hover h3,a:hover h4,a:hover h5{color:#3498db}.quote{margin:0 0 15px 0}blockquote{border-left:2px solid #ccc;font-style:italic;margin:0 0 15px 0;padding-left:20px}ol,ul{margin:0 0 15px 0;padding-left:25px}ul{list-style:square}ol{list-style:decimal}hr{background:#eee;color:#eee;clear:both;display:block;height:2px;margin:30px auto;width:50%}code,pre{color:#333;font-family:Courier,Menlo,Monaco;font-size:.8em;letter-spacing:0;overflow-x:auto}pre{padding:.8em 1em;white-space:pre-wrap}code{margin:0}.post::after{display:block;clear:both;content:''}.main-header{background-color:#005689;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;overflow:hidden;padding:1em;position:relative;text-align:center;width:100%}#menu{display:inline-block;margin:1px 0}#menu a{color:#fff;font-size:14px;margin-left:15px;padding:20px 10px;text-transform:uppercase}@media(max-width:500px){#menu a{margin-left:10px;padding:10px 5px}}#menu a:first-child{margin-left:0}#menu a[aria-current]{font-weight:700}#page{margin:0 auto;max-width:40em;padding:3em 2em;position:relative}.videoWrapper{height:0;margin-bottom:1em;padding-bottom:56.25%;padding-top:25px;position:relative}.videoWrapper amp-youtube,.videoWrapper iframe{height:100%;left:0;position:absolute;top:0;width:100%}.wrapper{border-top:2px solid #eee;padding:3em 0}.wrapper:first-child{border-top:none;padding-top:5%}.posts-list h2{margin-top:0}.post{display:block;width:100%}.post div[itemprop=articleBody]>p:first-child{color:#333}.post li{margin-bottom:.5em}.post p img{border:1px solid #eee;display:block;max-width:100%}.post img+.caption{padding-top:5px}.post .svg-container{margin-bottom:5%;max-width:100%;text-align:center}video{height:auto;max-width:100%}.post .svg-container object{width:100%}.tag-list{display:inline-block;list-style-type:none;margin:0;padding:0}.tag-list-item{display:inline-block;margin-left:.8em}.pagination{text-align:center}.pagination a{min-width:30px;max-height:30px;text-align:center}footer{border-top:1px dashed #ddd;padding:2em;text-align:center}.timing-stats{font-size:.7em;padding:.35em}.button{background-color:#fff;border:1px solid #555;border-radius:20px;color:#555;display:inline-block;font-size:13px;line-height:10px;padding:10px 20px;transition:background-color .15s ease-out}.button:hover{background-color:#3498db;border-color:transparent;color:#fff}.button.inactive{background-color:#ccc;color:#fff}.search-goog input{border:2px solid #ddd;padding:10px}.search-goog input[type=submit]{background-color:#ddd;cursor:pointer}@media only screen and (max-width:768px){#page,.wrapper{margin:0;max-width:100%;padding:1.5em;width:100%}.wrapper{padding:10% 0}.wraper::after{clear:both;content:'';display:block}.post{margin:0 auto;max-width:640px}}.outscreen{height:1px;left:-1000px;overflow:hidden;position:absolute;top:auto;width:1px}.callout{border:1px solid #eee;border-left-color:#777;border-left-width:5px;border-radius:3px;font-size:90%;padding:20px;margin:20px 0}.author{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:.8em;margin-bottom:2em}.author .name{line-height:1.5;padding-top:.35em}.bd,.media{overflow:hidden;zoom:1}.media .img{float:left}.avatar-img{border-radius:100%;height:3.5em;margin-right:.5em;width:3.5em}code[class*=language-],pre[class*=language-]{color:#393a34;font-family:Consolas,"Bitstream Vera Sans Mono","Courier New",Courier,monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:normal;font-size:.85em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border:1px solid #ddd;background-color:#fff}:not(pre)>code[class*=language-]{padding:.2em;padding-top:1px;padding-bottom:1px;background:#f8f8f8;border:1px solid #ddd}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#998;font-style:italic}.token.namespace{opacity:.7}.token.attr-value,.token.string{color:#e3116c}.token.operator,.token.punctuation{color:#393a34}.token.boolean,.token.constant,.token.entity,.token.inserted,.token.number,.token.property,.token.regex,.token.symbol,.token.url,.token.variable{color:#005cc5}.token.keyword{color:#d73a49}.token.atrule,.token.attr-name{color:#6f42c1}.token.deleted,.token.function{color:#6f42c1}.token.selector{color:#00009f}.token.tag{color:#22863a}.token.class-name{color:#6f42c1}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.code-wrap pre{white-space:pre-wrap}.caption{display:block;font-size:.8em;text-align:center}.codepen-aspect-ratio>iframe{height:100%;position:absolute;width:100%}.twitter-tweet{margin-left:auto;margin-right:auto}.twitter-tweet::after{content:"";display:block;padding-bottom:20px;width:100%}.me{max-width:20em;margin:0 auto .5em;text-align:center}.me h1{margin-bottom:0}</style><link rel=amphtml href="/paint-timing-api/amp/"><meta name=theme-color content=#005689><link rel=manifest href=/manifest.json></head><body><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-39254352-1","auto"),ga("send","pageview");</script><header class=main-header><nav id=menu><a href="/">Blog</a> <a href="/projects/">Projects</a> <a href="/talks/">Speaking</a> <a href="/about-me/">About</a></nav></header><div id=page><article class=wrapper><div class=post><header><script type=application/ld+json>{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "PerformanceObserver and Paint Timing API",
  
  "description": "A quick look at the Paint Timing API to get metrics about render events on our pages.",
  
  "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https://jmperezperez.com/paint-timing-api/"
  },
  "datePublished": "2017-06-17T07:15:00.000Z",
  "dateModified": "2018-04-08T08:11:57.951Z",
  
  "image": {
    "@type": "ImageObject",
    "url": "https://jmperezperez.com/assets/images/posts/paint-timing-filmstrip.png",
    "width" : "15000",
    "height" : "1388"
  },
  
  "author": {
      "@type": "Person",
      "name": "Jose M. Perez",
      "url": "https://jmperezperez.com",
      "sameAs": [
        "http://www.linkedin.com/in/jmperezperez",
        "https://twitter.com/jmperezperez"
      ]
  },
  "publisher": {
      "@type": "Organization",
      "name": "Jose M. Perez's Blog"
      
      ,
      "logo": {
        "@type": "ImageObject",
        "url": "https://jmperezperez.com/assets/images/logo.png",
        "width": 600,
        "height": 60
      }
      
  }
}</script><div class="media author"><div class=img><a href="/about-me/"><img src=https://res.cloudinary.com/jmperez/image/upload/w_120,f_auto,c_scale/v1519156883/profile_ysrm5y.jpg class=avatar-img alt="" height=53 width=53 sizes=53px></a></div><div class=bd><address class=name itemprop=author itemscope itemtype=https://schema.org/Person><a href="/about-me/" itemprop=name>José M. Pérez</a></address><meta class=post-data itemprop=datePublished content=2017-06-17T07:15:00.000Z>June 17 2017</div></div><h1>PerformanceObserver and Paint Timing API</h1></header><p>In <a href=https://blog.chromium.org/2017/06/chrome-60-beta-paint-timing-api-css.html target=_blank rel=noopener>a recent post about Chrome 60 Beta</a>, Google announced the support of the Paint Timing API to get metrics on when your page starts rendering and when the user gets content that can be consumed (more info on the definition of the events below). Here I’m going to describe this new API a bit and show you how to use it.</p><a id=more></a><p><img src=https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto,c_scale/v1510494808/paint-timing-example_byc6z2.png sizes="(max-width: 768px) 100vw, 684px" alt="Example of Paint Timing API entries"> <small class=caption>Image taken from the <a href=https://blog.chromium.org/2017/06/chrome-60-beta-paint-timing-api-css.html target=_blank rel=noopener>Chrome 60 blog post</a>, which first appeared in <a href=https://youtu.be/6Ljq-Jn-EgU target=_blank rel=noopener>“Web Performance: Leveraging the Metrics that Most Affect User Experience”</a> at Google I/O 2017</small></p><p>Up until now we have been measuring performance through other metrics, mostly using the <a href=https://developer.mozilla.org/docs/Web/API/Navigation_timing_API target=_blank rel=noopener>Navigation Timing API</a>, which is also what Google Analytics uses for their <a href="http://www.ericmobley.net/measuring-performance-google-analytics/" target=_blank rel=noopener>Site Speed report</a>. Yet those metrics don’t tell us the whole picture about the rendering experience.</p><p>The <a href=https://github.com/WICG/paint-timing target=_blank rel=noopener>Paint Timing API</a> aims to improve this by exposing metrics on paint events that are grouped in two types of entries. By <a href=https://w3c.github.io/paint-timing/#sec-terminology target=_blank rel=noopener>its definition</a>:</p><ul><li><code>&quot;first-paint&quot;</code> entries contain a <code>DOMHighResTimeStamp</code> reporting the time when the browser first rendered after navigation. This excludes the default background paint, but includes non-default background paint. This is the first key moment developers care about in page load – when the browser has started to render the page.</li><li><code>&quot;first-contentful-paint&quot;</code> contain a <code>DOMHighResTimestamp</code> reporting the time when the browser first rendered any text, image (including background images), non-white canvas or SVG. This includes text with pending webfonts. This is the first time users could start consuming page content.</li></ul><p>A picture is worth a thousand words, so let’s see how these entries would be reported by some real web sites:</p><p><img src=https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto,c_scale/v1510476598/paint-timing-filmstrip_anq3pv.png sizes="(max-width: 768px) 100vw, 684px" alt="Filmstrip from several sites showing when Paint Timing API entries are triggered"> <small class=caption>Image taken from the <a href=https://github.com/WICG/paint-timing#examples target=_blank rel=noopener>Paint timing API repo on WICG</a>.</small></p><h4 id=Hacking-on-it><a href=#Hacking-on-it class=headerlink title="Hacking on it"></a>Hacking on it</h4><p>As a hack project I decided to give it a try and implement it on a web site. You have a basic example <a href=https://github.com/WICG/paint-timing#usage target=_blank rel=noopener>on the Paint timing page</a>:</p><pre class=language-js><code class=language-js><span class="token keyword">var</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> perfEntries <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> perfEntries<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment" spellcheck=true>// Process entries</span>
     <span class="token comment" spellcheck=true>// report back for analytics and monitoring</span>
     <span class="token comment" spellcheck=true>// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck=true>// register observer for long task notifications</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>entryTypes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"paint"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>In practice you will probably want to report the information somewhere you can track it. If you are using Google Analytics, you can use <a href=https://developers.google.com/web/updates/2017/06/user-centric-performance-metrics#tracking_fpfcp target=_blank rel=noopener>this snippet from Google’s Developer site</a> (ES6):</p><pre class=language-js><code class=language-js><span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck=true>// `name` will be either 'first-paint' or 'first-contentful-paint'.</span>
    <span class="token keyword">const</span> metricName <span class="token operator">=</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>startTime <span class="token operator">+</span> entry<span class="token punctuation">.</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ga</span><span class="token punctuation">(</span><span class="token string">'send'</span><span class="token punctuation">,</span> <span class="token string">'event'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      eventCategory<span class="token punctuation">:</span> <span class="token string">'Performance Metrics'</span><span class="token punctuation">,</span>
      eventAction<span class="token punctuation">:</span> metricName<span class="token punctuation">,</span>
      eventValue<span class="token punctuation">:</span> time<span class="token punctuation">,</span>
      nonInteraction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck=true>// Start observing paint entries.</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>entryTypes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'paint'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id=Word-of-Caution><a href=#Word-of-Caution class=headerlink title="Word of Caution"></a>Word of Caution</h4><p>The API is still experimental and <a href=https://developer.mozilla.org/en-US/docs/Web/API/PerformanceObserver target=_blank rel=noopener>in “Editor’s Draft” state</a>. Also, the fact that a browser supports PerformanceObserver doesn’t mean that it supports the Paint events.</p><p>In the quick test I run, the above snippet would throw an exception:</p><pre><code>Uncaught TypeError: Failed to execute ‘observe’ on
‘PerformanceObserver’: A Performance Observer MUST
have at least one valid entryType in its entryTypes
attribute.
</code></pre><p>It turns out that if you only observe the <code>paint</code> entryType and this is not supported in the browser, <strong>it will throw an exception</strong>. According to <a href=https://w3c.github.io/performance-timeline/#dom-performanceobserverinit-entrytypes target=_blank rel=noopener>the specification</a>:</p><blockquote><p><code>entryTypes</code>: A list of entry names to be observed. The list must not be empty and types not recognized by the user agent must be ignored.</p></blockquote><p>In short, if you are giving this API a try, make sure you <code>try...catch</code> the <code>observer.observe()</code> call.</p><h4 id=Conclusions><a href=#Conclusions class=headerlink title=Conclusions></a>Conclusions</h4><p>This is a bit in early stages but I’m looking forward to see how the API evolves and we can use it to track Web Performance even better. This will also be a great addition to <a href="https://developers.google.com/web/tools/lighthouse/" target=_blank rel=noopener>LightHouse</a>, <a href=http://www.webpagetest.org target=_blank rel=noopener>WebPageTest</a>, <a href=https://calibreapp.com target=_blank rel=noopener>Calibre</a> and the rest of tools we use to monitor metrics on our sites.</p></div><hr/>Tags:<ul class=tag-list><li class=tag-list-item><a class=tag-list-link href="/tags/performance/">performance</a></li></ul></article></div><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js").then(function(n){})["catch"](function(n){})});</script><footer><section class=links><a href=https://twitter.com/jmperezperez>@jmperezperez</a> on Twitter · <a href=https://github.com/JMPerez>GitHub</a> · <a href=http://www.linkedin.com/in/jmperezperez>LinkedIn</a></section><div class=timing-stats></div></footer><script>window.addEventListener('load', () => {
     setTimeout(() => {
      var t = window.performance && performance.timing;
      function round2(num) { return Math.round(num * 100) / 100; }
      if (t) {
          var timingStats = document.querySelector('.timing-stats');
          var loadTime = (t.loadEventEnd - t.navigationStart) / 1000;
          var timingStatsHTML = 'This page loaded in ' + round2(loadTime) + ' seconds. ';
          var performanceEntries = performance.getEntriesByType('paint');
          performanceEntries.forEach(function(performanceEntry, i, entries) {
            var name = performanceEntry.name;
            if (name === 'first-paint') {
              name = '<abbr title=' + name + '>FP</abbr>';
            } else if (name === 'first-contentful-paint') {
              name = '<abbr title=' + name + '>FCP</abbr>';
            }
            timingStatsHTML += name + ' was ' + round2(performanceEntry.startTime / 1000) + ' seconds. ';
          });
          timingStats.innerHTML = timingStatsHTML;
      }
    }, 0);
   });</script><script>try {
    function isDecodeSupported() {
      const img = new Image();
      return typeof img.decode === 'function';
    }

    function isGaAvailable() {
      return !!window.ga;
    }

    async function loadAndDecode(src) {
      const img = new Image();
      img.src = src;
      const startTime = Date.now();
      await img.decode();
      return Date.now() - startTime;
    }

    setTimeout(() => {

      (async () => {
      if (isGaAvailable() && isDecodeSupported()) {
        const options = [
          '1000-q0',
          '1000-q80',
          '2000-q0',
          '2000-q80',
          '5169-q0',
          '5169-q80'
        ];

        // https://unsplash.com/photos/fPgooLPQB2Y
        const times = [];
        const option1 = options[0];
        times.push(await loadAndDecode(`https://jmperezperez.com/assets/decode/micael-widell-520896-unsplash-${option1}.jpg`));
        const option2 = options[1];
        times.push(await loadAndDecode(`https://jmperezperez.com/assets/decode/micael-widell-520896-unsplash-${option2}.jpg`));
        const option3 = options[2];
        times.push(await loadAndDecode(`https://jmperezperez.com/assets/decode/micael-widell-520896-unsplash-${option3}.jpg`));
        const option4 = options[3];
        times.push(await loadAndDecode(`https://jmperezperez.com/assets/decode/micael-widell-520896-unsplash-${option4}.jpg`));
        const option5 = options[4];
        times.push(await loadAndDecode(`https://jmperezperez.com/assets/decode/micael-widell-520896-unsplash-${option5}.jpg`));
        const option6 = options[5];
        times.push(await loadAndDecode(`https://jmperezperez.com/assets/decode/micael-widell-520896-unsplash-${option6}.jpg`));

        console.log(times);
        options.forEach((option, index) => {
          ga('send', 'event', 'image-decode-2', option, times[index]);
        });

      }})();
    }, 5000);
  } catch (e) {

  }</script></body></html>